<!DOCTYPE html>
<html>
<head>
    <title>SignalR Test - Server Monitoring (Full Protocol Test)</title>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1600px; margin: 0 auto; background: #f5f5f5; }
        .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .container { display: grid; grid-template-columns: 380px 1fr; gap: 20px; }
        .panel { background: white; border: 1px solid #ddd; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .section { margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .section:last-child { border-bottom: none; }
        .status { padding: 12px; margin: 10px 0; border-radius: 6px; font-weight: 500; }
        .connected { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .disconnected { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .authenticated { background: #cce5ff; color: #004085; border: 1px solid #b8daff; }
        button { padding: 10px 18px; margin: 5px 5px 5px 0; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 5px; font-size: 14px; transition: all 0.2s; }
        button:hover { background: #0056b3; transform: translateY(-1px); }
        button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
        button.warning { background: #ffc107; color: #212529; }
        button.warning:hover { background: #e0a800; }
        #output { background: #f8f9fa; padding: 15px; border-radius: 5px; max-height: 600px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 13px; }
        .output-item { margin: 10px 0; padding: 12px; background: white; border-left: 4px solid #007bff; border-radius: 4px; }
        .output-item.success { border-left-color: #28a745; }
        .output-item.error { border-left-color: #dc3545; }
        .output-item.info { border-left-color: #17a2b8; }
        .output-item.alert { border-left-color: #ffc107; background: #fff3cd; }
        .timestamp { color: #666; font-size: 0.85em; margin-bottom: 5px; }
        input, select, textarea { padding: 8px; margin: 5px 5px 5px 0; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        input[type="text"], input[type="password"] { width: 200px; }
        input[type="number"] { width: 100px; }
        textarea { width: 100%; min-height: 80px; font-family: monospace; }
        .login-panel { background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px; }
        h2 { margin-top: 0; color: #333; font-size: 18px; border-bottom: 2px solid #007bff; padding-bottom: 8px; }
        h3 { color: #555; font-size: 16px; margin-top: 15px; margin-bottom: 10px; }
        .info-box { background: #e7f3ff; padding: 12px; border-radius: 6px; margin: 10px 0; border-left: 4px solid #2196F3; }
        .command-group { background: #f9f9f9; padding: 12px; border-radius: 6px; margin: 10px 0; }
        label { display: inline-block; margin-right: 10px; font-weight: 500; color: #555; }
        .tab-buttons { display: flex; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; }
        .tab-button { background: #e9ecef; color: #495057; }
        .tab-button.active { background: #007bff; color: white; }
        code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; font-size: 0.9em; }
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: 600; }
        .badge-success { background: #28a745; color: white; }
        .badge-danger { background: #dc3545; color: white; }
        .badge-warning { background: #ffc107; color: #212529; }
        .badge-info { background: #17a2b8; color: white; }
        .chat-id-item { background: #f8f9fa; padding: 8px; margin: 5px 0; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .alert-rule-item { background: #f8f9fa; padding: 10px; margin: 8px 0; border-radius: 4px; border-left: 3px solid #007bff; }
        .alert-item { background: white; padding: 12px; margin: 8px 0; border-radius: 4px; border-left: 4px solid #ffc107; }
        .collapsible { cursor: pointer; user-select: none; }
        .collapsible:hover { background: #f0f0f0; }
        .content-collapsed { display: none; }
        .install-command { background: #2d2d2d; color: #f8f8f2; padding: 12px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 13px; margin: 10px 0; overflow-x: auto; }
        .agent-item { background: #f8f9fa; padding: 12px; margin: 8px 0; border-radius: 4px; border-left: 3px solid #007bff; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>
    <div class="header">
        <h1>🖥️ Server Monitoring - Full Protocol Test Suite + Alert System + Agent Installation</h1>
        <p>Test WebSocket communication, agent commands, real-time updates, alerts, Telegram notifications, and agent installation</p>
    </div>
    
    <div class="container">
        <!-- Left Panel: Controls -->
        <div class="panel" style="overflow-y: auto; max-height: 90vh;">
            <!-- Authentication -->
            <div class="section">
                <h2>🔐 Authentication</h2>
                <div id="authStatus" class="status disconnected">❌ Not Authenticated</div>
                <div id="loginForm">
                    <input type="text" id="email" placeholder="Email" value="admin@example.com" /><br/>
                    <input type="password" id="password" placeholder="Password" value="admin123" /><br/>
                    <button onclick="login()">Login</button>
                </div>
                <div id="userInfo" style="display:none; margin-top: 10px;">
                    <p><strong>User:</strong> <span id="userEmail"></span></p>
                    <button class="danger" onclick="logout()">Logout</button>
                </div>
            </div>

            <!-- 🆕 Agent Installation -->
            <div class="section">
                <h2>📦 Agent Installation</h2>
                
                <h3>Register New Agent</h3>
                <div class="command-group">
                    <label>Agent Name:</label>
                    <input type="text" id="newAgentName" placeholder="e.g., Production Server" style="width: 200px;" />
                </div>
                <button class="success" onclick="registerAgent()">Register Agent</button>
                
                <h3>Agent List</h3>
                <button onclick="loadAgents()">Refresh Agents</button>
                <div id="agentsList"></div>
            </div>

            <!-- SignalR Connection -->
            <div class="section">
                <h2>📡 SignalR Connection</h2>
                <div id="status" class="status disconnected">❌ Disconnected</div>
                <button id="connectBtn" onclick="connect()" disabled>Connect to Hub</button>
                <button class="danger" id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
                
                <h3>Subscribe to Server</h3>
                <input type="number" id="serverIdInput" value="1" placeholder="Server ID" />
                <button class="success" id="subscribeBtn" onclick="subscribe()" disabled>Subscribe</button>
                <button class="danger" id="unsubscribeBtn" onclick="unsubscribe()" disabled>Unsubscribe</button>
            </div>

            <!-- Server Commands -->
            <div class="section">
                <h2>🖥️ Server Commands</h2>
                <div class="command-group">
                    <label>Server ID:</label>
                    <input type="number" id="cmdServerId" value="1" style="width: 80px;" />
                </div>
                
                <button onclick="getServerInfo()">Get Server Info</button>
                <button onclick="getServices()">List Services</button>
                <button onclick="getProcesses()">List Processes</button>
            </div>

            <!-- Service Commands -->
            <div class="section">
                <h2>⚙️ Service Management</h2>
                <div class="command-group">
                    <label>Service Name:</label>
                    <input type="text" id="serviceName" value="nginx" placeholder="e.g., nginx" style="width: 150px;" />
                </div>
                
                <button onclick="getServiceDetails()">Get Details</button>
                <button onclick="getServiceLogs()">Get Logs</button>
                <button class="danger" onclick="restartService()">Restart Service</button>
            </div>

            <!-- Process Commands -->
            <div class="section">
                <h2>📊 Process Management</h2>
                <div class="command-group">
                    <label>Process ID:</label>
                    <input type="number" id="processPid" value="1" placeholder="PID" style="width: 100px;" />
                </div>
                
                <button onclick="getProcessDetails()">Get Process Details</button>
            </div>

            <!-- Configuration -->
            <div class="section">
                <h2>🔧 Agent Configuration</h2>
                <div class="command-group">
                    <label>Metrics Interval (s):</label>
                    <input type="number" id="configInterval" value="5" min="0" max="3600" style="width: 80px;" /><br/>
                    
                    <label>Watchlist Services:</label>
                    <input type="text" id="configWatchlistServices" value="nginx,postgresql,docker" placeholder="service1,service2" style="width: 250px;" /><br/>
                    
                    <label>Watchlist Processes:</label>
                    <input type="text" id="configWatchlistProcesses" value="" placeholder="python app.py,node server.js" style="width: 250px;" />
                    <div style="font-size: 0.85em; color: #666; margin-top: 5px;">
                        ℹ️ Services: comma-separated names<br/>
                        ℹ️ Processes: comma-separated command lines
                    </div>
                </div>
                
                <button class="success" onclick="updateAgentConfig()">Update Configuration</button>
            </div>

            <!-- 🆕 Notification Settings -->
            <div class="section">
                <h2>🔔 Telegram Notification Settings</h2>
                <button onclick="getNotificationSettings()">Load Settings</button>
                <button onclick="testTelegramConnection()">Test Connection</button>
                
                <h3>Bot Token</h3>
                <input type="text" id="telegramBotToken" placeholder="Bot Token from @BotFather" style="width: 280px;" /><br/>
                <button class="success" onclick="updateBotToken()">Update Bot Token</button>
                
                <h3>Enable/Disable</h3>
                <button class="success" onclick="enableTelegram()">Enable Telegram</button>
                <button class="danger" onclick="disableTelegram()">Disable Telegram</button>
                
                <h3>Chat IDs</h3>
                <div id="chatIdsList" style="margin: 10px 0;"></div>
                <input type="text" id="newChatId" placeholder="Chat ID" style="width: 150px;" />
                <input type="text" id="newChatLabel" placeholder="Label (optional)" style="width: 120px;" />
                <button class="success" onclick="addChatId()">Add Chat ID</button>
            </div>

            <!-- Test -->
            <div class="section">
                <h2>🧪 Testing</h2>
                <button onclick="clearOutput()">Clear Output</button>
                <button onclick="triggerTest()">Send Test Metrics</button>
            </div>
        </div>
        
        <!-- Right Panel: Output -->
        <div class="panel">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('output')">📋 Output Log</button>
                <button class="tab-button" onclick="switchTab('metrics')">📊 Live Metrics</button>
                <button class="tab-button" onclick="switchTab('alertRules')">⚠️ Alert Rules</button>
                <button class="tab-button" onclick="switchTab('alerts')">🔔 Alerts</button>
            </div>
            
            <div id="outputTab">
                <div class="info-box">
                    <strong>Protocol Test Suite + Alert System</strong><br/>
                    All commands use the new protocol. Alert system tests Telegram notifications.
                </div>
                <div id="output">
                    <p style="color: #999;">Waiting for commands...</p>
                </div>
            </div>

            <div id="metricsTab" style="display: none;">
                <div id="metrics">
                    <p style="color: #999;">Waiting for metrics...</p>
                </div>
            </div>

            <!-- 🆕 Alert Rules Tab -->
            <div id="alertRulesTab" style="display: none;">
                <div class="info-box">
                    <strong>Alert Rules Management</strong><br/>
                    Create, view, and manage alert rules for your servers.
                </div>
                
                <h3>Create New Alert Rule</h3>
                <div class="command-group">
                    <label>Server ID:</label>
                    <input type="number" id="alertRuleServerId" value="1" style="width: 80px;" /><br/>
                    
                    <label>Metric:</label>
                    <select id="alertRuleMetric" style="width: 200px;">
                        <option value="CPU">CPU</option>
                        <option value="RAM">RAM</option>
                        <option value="LOAD1M">Load 1m</option>
                        <option value="LOAD5M">Load 5m</option>
                        <option value="LOAD15M">Load 15m</option>
                        <option value="DISKUSAGE">Disk Usage</option>
                        <option value="NETWORKUPLOAD">Network Upload</option>
                        <option value="NETWORKDOWNLOAD">Network Download</option>
                    </select><br/>
                    
                    <label>Target Type:</label>
                    <select id="alertRuleTargetType" style="width: 150px;">
                        <option value="0">Server</option>
                        <option value="1">Disk (any)</option>
                        <option value="2">Network (any)</option>
                        <option value="3">Process</option>
                        <option value="4">Service</option>
                    </select><br/>
                    
                    <label>Target ID:</label>
                    <input type="text" id="alertRuleTargetId" placeholder="Optional (e.g., /dev/sda1, eth0, python)" style="width: 200px;" /><br/>
                    
                    <label>Comparison:</label>
                    <select id="alertRuleComparison" style="width: 100px;">
                        <option value=">">&gt;</option>
                        <option value=">=">&gt;=</option>
                        <option value="<">&lt;</option>
                        <option value="<=">&lt;=</option>
                        <option value="==">==</option>
                    </select>
                    
                    <label>Threshold:</label>
                    <input type="number" id="alertRuleThreshold" value="80" step="0.1" style="width: 100px;" /><br/>
                    
                    <label>Severity:</label>
                    <select id="alertRuleSeverity" style="width: 120px;">
                        <option value="Info">Info</option>
                        <option value="Warning" selected>Warning</option>
                        <option value="Critical">Critical</option>
                    </select>
                    
                    <label>Cooldown (min):</label>
                    <input type="number" id="alertRuleCooldown" value="15" min="1" style="width: 80px;" /><br/>
                </div>
                <button class="success" onclick="createAlertRule()">Create Alert Rule</button>
                
                <h3>Existing Alert Rules</h3>
                <button onclick="loadAlertRules()">Refresh Rules</button>
                <div id="alertRulesList"></div>
            </div>

            <!-- 🆕 Alerts Tab -->
            <div id="alertsTab" style="display: none;">
                <div class="info-box">
                    <strong>Alert History</strong><br/>
                    View and acknowledge triggered alerts.
                </div>
                
                <h3>Filters</h3>
                <div class="command-group">
                    <label>Server ID:</label>
                    <input type="number" id="filterAlertServerId" placeholder="All" style="width: 80px;" />
                    
                    <label>Severity:</label>
                    <select id="filterAlertSeverity" style="width: 120px;">
                        <option value="">All</option>
                        <option value="Info">Info</option>
                        <option value="Warning">Warning</option>
                        <option value="Critical">Critical</option>
                    </select>
                    
                    <label>Status:</label>
                    <select id="filterAlertAcknowledged" style="width: 150px;">
                        <option value="">All</option>
                        <option value="false">Unacknowledged</option>
                        <option value="true">Acknowledged</option>
                    </select>
                    
                    <button onclick="loadAlerts()">Apply Filters</button>
                </div>
                
                <h3>Alert List</h3>
                <button onclick="loadAlerts()">Refresh Alerts</button>
                <button class="danger" onclick="deleteAcknowledgedAlerts()">Delete Acknowledged</button>
                <div id="alertsList"></div>
            </div>
        </div>
    </div>

    <script>
        let connection = null;
        let currentServerId = null;
        let jwtToken = null;
        let currentTab = 'output';

        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('outputTab').style.display = tab === 'output' ? 'block' : 'none';
            document.getElementById('metricsTab').style.display = tab === 'metrics' ? 'block' : 'none';
            document.getElementById('alertRulesTab').style.display = tab === 'alertRules' ? 'block' : 'none';
            document.getElementById('alertsTab').style.display = tab === 'alerts' ? 'block' : 'none';
            
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Auto-load data when switching to alert tabs
            if (tab === 'alertRules') loadAlertRules();
            if (tab === 'alerts') loadAlerts();
        }

        function logOutput(message, type = 'info') {
            const outputDiv = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            
            const html = `
                <div class="output-item ${type}">
                    <div class="timestamp">🕐 ${timestamp}</div>
                    <div>${message}</div>
                </div>
            `;
            
            outputDiv.innerHTML = html + outputDiv.innerHTML;
        }

        function clearOutput() {
            document.getElementById('output').innerHTML = '<p style="color: #999;">Output cleared...</p>';
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('https://localhost:7287/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                if (!response.ok) {
                    throw new Error('Invalid credentials');
                }

                const data = await response.json();
                jwtToken = data.token;
                
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('userInfo').style.display = 'block';
                document.getElementById('userEmail').textContent = data.user.email;
                document.getElementById('authStatus').className = 'status authenticated';
                document.getElementById('authStatus').textContent = '✅ Authenticated';
                document.getElementById('connectBtn').disabled = false;

                logOutput(`✅ Logged in as <strong>${data.user.email}</strong>`, 'success');
                
                // Auto-load agents
                loadAgents();
            } catch (err) {
                logOutput(`❌ Login failed: ${err.message}`, 'error');
            }
        }

        function logout() {
            jwtToken = null;
            if (connection) {
                connection.stop();
            }
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('authStatus').className = 'status disconnected';
            document.getElementById('authStatus').textContent = '❌ Not Authenticated';
            document.getElementById('connectBtn').disabled = true;
            updateStatus(false);
            logOutput('🔒 Logged out', 'info');
        }

        async function connect() {
            if (!jwtToken) {
                alert('Please login first!');
                return;
            }

            try {
                connection = new signalR.HubConnectionBuilder()
                    .withUrl("https://localhost:7287/monitoring-hub", {
                        accessTokenFactory: () => jwtToken
                    })
                    .configureLogging(signalR.LogLevel.Information)
                    .build();

                connection.on("MetricsUpdated", (data) => {
                    displayMetrics(data);
                });

                // 🆕 Listen for AlertTriggered events
                connection.on("AlertTriggered", (data) => {
                    displayAlert(data);
                });

                connection.onclose(() => {
                    updateStatus(false);
                    logOutput('📡 SignalR connection closed', 'info');
                });

                await connection.start();
                updateStatus(true);
                logOutput(`📡 SignalR Connected! Connection ID: <code>${connection.connectionId}</code>`, 'success');
            } catch (err) {
                logOutput(`❌ Connection error: ${err.message}`, 'error');
            }
        }

        async function disconnect() {
            if (connection) {
                await connection.stop();
                updateStatus(false);
                logOutput('📡 SignalR Disconnected', 'info');
            }
        }

        async function subscribe() {
            const serverId = parseInt(document.getElementById('serverIdInput').value);
            if (!connection || connection.state !== signalR.HubConnectionState.Connected) {
                alert("Please connect first!");
                return;
            }

            try {
                const response = await fetch(`https://localhost:7287/api/monitoring/subscribe/${serverId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`,
                        'X-SignalR-ConnectionId': connection.connectionId
                    }
                });

                if (!response.ok) throw new Error('Subscription failed');

                const result = await response.json();
                currentServerId = serverId;
                document.getElementById('unsubscribeBtn').disabled = false;
                logOutput(`✅ Subscribed to server <strong>${serverId}</strong>`, 'success');
            } catch (err) {
                logOutput(`❌ Subscribe error: ${err.message}`, 'error');
            }
        }

        async function unsubscribe() {
            if (!currentServerId) return;

            try {
                const response = await fetch(`https://localhost:7287/api/monitoring/unsubscribe/${currentServerId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`,
                        'X-SignalR-ConnectionId': connection.connectionId
                    }
                });

                if (!response.ok) throw new Error('Unsubscribe failed');

                logOutput(`✅ Unsubscribed from server <strong>${currentServerId}</strong>`, 'success');
                currentServerId = null;
                document.getElementById('unsubscribeBtn').disabled = true;
            } catch (err) {
                logOutput(`❌ Unsubscribe error: ${err.message}`, 'error');
            }
        }

        // ===== AGENT COMMAND FUNCTIONS (existing code remains same) =====

        async function getServerInfo() {
            const serverId = parseInt(document.getElementById('cmdServerId').value);
            logOutput(`⏳ Requesting server info for server ${serverId}...`, 'info');

            try {
                const response = await fetch(`https://localhost:7287/api/server/${serverId}/info`, {
                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Request failed');
                }

                const data = await response.json();
                
                const html = `
                    <strong>🖥️ Server Information:</strong><br/>
                    • Hostname: <code>${data.data.hostname}</code><br/>
                    • IP: <code>${data.data.ipAddress}</code><br/>
                    • OS: <code>${data.data.os} ${data.data.osVersion}</code><br/>
                    • Kernel: <code>${data.data.kernel}</code><br/>
                    • Architecture: <code>${data.data.architecture}</code><br/>
                    • CPU: <code>${data.data.cpuModel}</code><br/>
                    • Cores: <code>${data.data.cpuCores}</code> / Threads: <code>${data.data.cpuThreads}</code>
                `;
                
                logOutput(html, 'success');
            } catch (err) {
                logOutput(`❌ Get server info error: ${err.message}`, 'error');
            }
        }

        async function getServices() {
            const serverId = parseInt(document.getElementById('cmdServerId').value);
            logOutput(`⏳ Fetching services list for server ${serverId}...`, 'info');

            try {
                const response = await fetch(`https://localhost:7287/api/servers/${serverId}/services`, {
                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Request failed');
                }

                const result = await response.json();
                const services = result.data || result;
                
                let html = `<strong>⚙️ Services (${services.length}):</strong><br/>`;
                services.slice(0, 10).forEach(svc => {
                    const statusIcon = svc.activeState === 'active' ? '🟢' : '🔴';
                    html += `${statusIcon} <code>${svc.name}</code> - ${svc.activeState} (${svc.subState})<br/>`;
                });
                
                if (services.length > 10) {
                    html += `<em>... and ${services.length - 10} more</em>`;
                }
                
                logOutput(html, 'success');
            } catch (err) {
                logOutput(`❌ Get services error: ${err.message}`, 'error');
            }
        }

        async function getServiceDetails() {
            const serverId = parseInt(document.getElementById('cmdServerId').value);
            const serviceName = document.getElementById('serviceName').value;
            
            if (!serviceName) {
                alert('Please enter a service name');
                return;
            }

            logOutput(`⏳ Fetching details for service <strong>${serviceName}</strong>...`, 'info');

            try {
                const response = await fetch(`https://localhost:7287/api/servers/${serverId}/services/${serviceName}`, {
                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Request failed');
                }

                const result = await response.json();
                const data = result.data || result;
                
                const html = `
                    <strong>⚙️ Service Details: ${data.name}</strong><br/>
                    • Status: <code>${data.activeState}</code> (${data.subState})<br/>
                    • PID: <code>${data.mainPID || 'N/A'}</code><br/>
                    • CPU: <code>${data.cpuUsagePercent?.toFixed(2) || 'N/A'}%</code><br/>
                    • Memory: <code>${data.memoryUsage?.toFixed(2) || 'N/A'} MB</code><br/>
                    • Restart Policy: <code>${data.restartPolicy || 'N/A'}</code><br/>
                    • Start Time: <code>${data.startTime || 'N/A'}</code>
                `;
                
                logOutput(html, 'success');
            } catch (err) {
                logOutput(`❌ Get service details error: ${err.message}`, 'error');
            }
        }

        async function getServiceLogs() {
            const serverId = parseInt(document.getElementById('cmdServerId').value);
            const serviceName = document.getElementById('serviceName').value;
            
            if (!serviceName) {
                alert('Please enter a service name');
                return;
            }

            logOutput(`⏳ Fetching logs for service <strong>${serviceName}</strong>...`, 'info');

            try {
                const response = await fetch(`https://localhost:7287/api/servers/${serverId}/services/${serviceName}/logs`, {
                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Request failed');
                }

                const result = await response.json();
                const logs = result.data || result;
                
                let html = `<strong>📜 Service Logs (${logs.length} lines):</strong><br/><pre style="background:#f4f4f4;padding:10px;border-radius:4px;max-height:200px;overflow:auto;">`;
                logs.slice(0, 20).forEach(log => {
                    html += `${log.log}\n`;
                });
                html += '</pre>';
                
                if (logs.length > 20) {
                    html += `<em>... ${logs.length - 20} more lines</em>`;
                }
                
                logOutput(html, 'success');
            } catch (err) {
                logOutput(`❌ Get service logs error: ${err.message}`, 'error');
            }
        }

        async function restartService() {
            const serverId = parseInt(document.getElementById('cmdServerId').value);
            const serviceName = document.getElementById('serviceName').value;
            
            if (!serviceName) {
                alert('Please enter a service name');
                return;
            }

            if (!confirm(`Are you sure you want to restart ${serviceName}?`)) {
                return;
            }

            logOutput(`⏳ Restarting service <strong>${serviceName}</strong>...`, 'info');

            try {
                const response = await fetch(`https://localhost:7287/api/servers/${serverId}/services/${serviceName}/restart`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Request failed');
                }

                const result = await response.json();
                logOutput(`✅ Service <strong>${serviceName}</strong> restart initiated!`, 'success');
            } catch (err) {
                logOutput(`❌ Restart service error: ${err.message}`, 'error');
            }
        }

        async function getProcesses() {
            const serverId = parseInt(document.getElementById('cmdServerId').value);
            logOutput(`⏳ Fetching process list for server ${serverId}...`, 'info');

            try {
                const response = await fetch(`https://localhost:7287/api/servers/${serverId}/processes`, {
                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Request failed');
                }

                const result = await response.json();
                const processes = result.data || result;
                
                let html = `<strong>📊 Processes (${processes.length}):</strong><br/>`;
                processes.slice(0, 15).forEach(proc => {
                    html += `• PID <code>${proc.pid}</code>: <strong>${proc.name}</strong> (${proc.user}) - CPU: ${proc.cpuPercent.toFixed(1)}%, MEM: ${proc.memoryPercent.toFixed(1)}%<br/>`;
                });
                
                if (processes.length > 15) {
                    html += `<em>... and ${processes.length - 15} more</em>`;
                }
                
                logOutput(html, 'success');
            } catch (err) {
                logOutput(`❌ Get processes error: ${err.message}`, 'error');
            }
        }

        async function getProcessDetails() {
            const serverId = parseInt(document.getElementById('cmdServerId').value);
            const pid = parseInt(document.getElementById('processPid').value);

            logOutput(`⏳ Fetching details for process <strong>PID ${pid}</strong>...`, 'info');

            try {
                const response = await fetch(`https://localhost:7287/api/servers/${serverId}/processes/${pid}`, {
                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Request failed');
                }

                const result = await response.json();
                const data = result.data || result;
                
                const html = `
                    <strong>📊 Process Details: PID ${data.pid}</strong><br/>
                    • Name: <code>${data.name}</code><br/>
                    • User: <code>${data.user}</code><br/>
                    • Status: <code>${data.status}</code><br/>
                    • CPU: <code>${data.cpuPercent.toFixed(2)}%</code><br/>
                    • Memory: <code>${data.memoryPercent.toFixed(2)}%</code><br/>
                    • Threads: <code>${data.numThreads || 'N/A'}</code><br/>
                    • Nice: <code>${data.nice || 'N/A'}</code><br/>
                    • Uptime: <code>${data.uptimeSeconds || 'N/A'}s</code><br/>
                    • Command: <code style="word-break:break-all;">${data.cmdline || 'N/A'}</code>
                `;
                
                logOutput(html, 'success');
            } catch (err) {
                logOutput(`❌ Get process details error: ${err.message}`, 'error');
            }
        }

        async function updateAgentConfig() {
            const serverId = parseInt(document.getElementById('cmdServerId').value);
            const interval = parseInt(document.getElementById('configInterval').value);
            
            const servicesStr = document.getElementById('configWatchlistServices').value;
            const services = servicesStr ? servicesStr.split(',').map(s => s.trim()).filter(s => s) : [];
            
            const processesStr = document.getElementById('configWatchlistProcesses').value;
            const processes = processesStr ? processesStr.split(',').map(s => s.trim()).filter(s => s) : [];

            logOutput(`⏳ Updating agent configuration...`, 'info');

            try {
                const requestBody = {
                    metricsInterval: interval,
                    watchlist: {
                        services: services,
                        processes: processes
                    }
                };

                const response = await fetch(`https://localhost:7287/api/servers/${serverId}/configuration`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Request failed');
                }

                const result = await response.json();
                
                let logMsg = `✅ Agent configuration updated:<br/>• Interval: ${interval}s`;
                if (services.length > 0) {
                    logMsg += `<br/>• Services: [${services.join(', ')}]`;
                }
                if (processes.length > 0) {
                    logMsg += `<br/>• Processes: [${processes.join(', ')}]`;
                }
                
                logOutput(logMsg, 'success');
            } catch (err) {
                logOutput(`❌ Update config error: ${err.message}`, 'error');
            }
        }

        async function triggerTest() {
            const serverId = parseInt(document.getElementById('cmdServerId').value);

            try {
                const response = await fetch(`https://localhost:7287/api/test/broadcast-test?serverId=${serverId}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                });

                if (!response.ok) throw new Error('Test broadcast failed');

                logOutput('✅ Test metrics broadcast triggered', 'success');
            } catch (err) {
                logOutput(`❌ Test error: ${err.message}`, 'error');
            }
        }

        function displayMetrics(data) {
            const metricsDiv = document.getElementById('metrics');
            
            const metricHtml = `
                <div class="output-item">
                    <div class="timestamp">🕐 ${new Date(data.timestampUtc).toLocaleString()}</div>
                    <h4>Server ${data.monitoredServerId} - Metric #${data.id}</h4>
                    <p>
                        <strong>CPU:</strong> ${data.cpuUsagePercent.toFixed(1)}% | 
                        <strong>RAM:</strong> ${data.ramUsagePercent.toFixed(1)}% (${data.ramUsedGb.toFixed(2)} GB)
                    </p>
                    <p>
                        <strong>Load:</strong> ${data.load1m.toFixed(2)} / ${data.load5m.toFixed(2)} / ${data.load15m.toFixed(2)}
                    </p>
                    <p>
                        <strong>Disk I/O:</strong> R: ${data.diskReadSpeedMBps.toFixed(2)} MB/s | W: ${data.diskWriteSpeedMBps.toFixed(2)} MB/s
                    </p>
                    <p><strong>Disks:</strong> ${data.diskPartitions.length} partitions</p>
                    <p><strong>Network:</strong> ${data.networkInterfaces.length} interfaces</p>
                </div>
            `;
            
            metricsDiv.innerHTML = metricHtml + metricsDiv.innerHTML;
        }

        // 🆕 Display real-time alert from SignalR
        function displayAlert(data) {
            const emoji = data.severity === 'Critical' ? '🔴' : data.severity === 'Warning' ? '⚠️' : 'ℹ️';
            const html = `
                <strong>${emoji} ALERT: ${data.title}</strong><br/>
                • Server: ${data.serverId}<br/>
                • Message: ${data.message}<br/>
                • Severity: <span class="badge badge-${data.severity.toLowerCase()}">${data.severity}</span><br/>
                • Metric: ${data.metric} = ${data.actualValue?.toFixed(2)} (threshold: ${data.thresholdValue})<br/>
                • Time: ${new Date(data.timestamp).toLocaleString()}
            `;
            logOutput(html, 'alert');
            
            // Also refresh alerts tab if active
            if (currentTab === 'alerts') {
                loadAlerts();
            }
        }

        function updateStatus(connected) {
            const statusDiv = document.getElementById('status');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const subscribeBtn = document.getElementById('subscribeBtn');
            
            if (connected) {
                statusDiv.className = 'status connected';
                statusDiv.textContent = '✅ Connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                subscribeBtn.disabled = false;
            } else {
                statusDiv.className = 'status disconnected';
                statusDiv.textContent = '❌ Disconnected';
                connectBtn.disabled = jwtToken === null;
                disconnectBtn.disabled = true;
                subscribeBtn.disabled = true;
                document.getElementById('unsubscribeBtn').disabled = true;
            }
        }

        // ===== 🆕 NOTIFICATION SETTINGS FUNCTIONS =====

        async function getNotificationSettings() {
            logOutput('⏳ Loading notification settings...', 'info');
            
            try {
                const response = await fetch('https://localhost:7287/api/notification-settings', {
                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                });

                if (!response.ok) throw new Error('Failed to load settings');

                const data = await response.json();
                
                let html = `<strong>🔔 Current Settings:</strong><br/>`;
                html += `• Telegram Enabled: ${data.isTelegramEnabled ? '✅ Yes' : '❌ No'}<br/>`;
                html += `• Bot Token: ${data.hasBotToken ? '✅ Configured' : '❌ Not set'}<br/>`;
                html += `• Chat IDs: ${data.chatIds.length}<br/>`;
                
                logOutput(html, 'success');

                // Display chat IDs
                displayChatIds(data.chatIds);
            } catch (err) {
                logOutput(`❌ Get settings error: ${err.message}`, 'error');
            }
        }

        function displayChatIds(chatIds) {
            const container = document.getElementById('chatIdsList');
            if (!chatIds || chatIds.length === 0) {
                container.innerHTML = '<p style="color:#999;">No chat IDs configured</p>';
                return;
            }

            let html = '';
            chatIds.forEach(chat => {
                html += `
                    <div class="chat-id-item">
                        <div>
                            <strong>${chat.chatId}</strong>
                            ${chat.label ? `<br/><small>${chat.label}</small>` : ''}
                        </div>
                        <button class="danger" style="padding:5px 10px;" onclick="deleteChatId(${chat.id})">Delete</button>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        async function updateBotToken() {
            const token = document.getElementById('telegramBotToken').value;
            if (!token) {
                alert('Please enter a bot token');
                return;
            }

            logOutput('⏳ Updating bot token...', 'info');

            try {
                const response = await fetch('https://localhost:7287/api/notification-settings/telegram/bot-token', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ botToken: token })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to update');
                }

                logOutput('✅ Bot token updated successfully', 'success');
                document.getElementById('telegramBotToken').value = '';
            } catch (err) {
                logOutput(`❌ Update bot token error: ${err.message}`, 'error');
            }
        }

        async function enableTelegram() {
            logOutput('⏳ Enabling Telegram notifications...', 'info');

            try {
                const response = await fetch('https://localhost:7287/api/notification-settings/telegram/enabled', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ enabled: true })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to enable');
                }

                logOutput('✅ Telegram notifications enabled', 'success');
            } catch (err) {
                logOutput(`❌ Enable Telegram error: ${err.message}`, 'error');
            }
        }

        async function disableTelegram() {
            logOutput('⏳ Disabling Telegram notifications...', 'info');

            try {
                const response = await fetch('https://localhost:7287/api/notification-settings/telegram/enabled', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ enabled: false })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to disable');
                }

                logOutput('✅ Telegram notifications disabled', 'success');
            } catch (err) {
                logOutput(`❌ Disable Telegram error: ${err.message}`, 'error');
            }
        }

        async function testTelegramConnection() {
            logOutput('⏳ Testing Telegram bot connection...', 'info');

            try {
                const response = await fetch('https://localhost:7287/api/notification-settings/telegram/test', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                });

                const result = await response.json();

                if (result.success) {
                    logOutput('✅ Telegram bot connection successful!', 'success');
                } else {
                    logOutput('❌ Telegram bot connection failed. Check bot token.', 'error');
                }
            } catch (err) {
                logOutput(`❌ Test connection error: ${err.message}`, 'error');
            }
        }

        async function addChatId() {
            const chatId = document.getElementById('newChatId').value;
            const label = document.getElementById('newChatLabel').value;

            if (!chatId) {
                alert('Please enter a chat ID');
                return;
            }

            logOutput(`⏳ Adding chat ID ${chatId}...`, 'info');

            try {
                const response = await fetch('https://localhost:7287/api/notification-settings/telegram/chat-ids', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ chatId, label: label || null })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to add');
                }

                logOutput(`✅ Chat ID ${chatId} added successfully`, 'success');
                document.getElementById('newChatId').value = '';
                document.getElementById('newChatLabel').value = '';
                getNotificationSettings();
            } catch (err) {
                logOutput(`❌ Add chat ID error: ${err.message}`, 'error');
            }
        }

        async function deleteChatId(id) {
            if (!confirm('Delete this chat ID?')) return;

            logOutput(`⏳ Deleting chat ID...`, 'info');

            try {
                const response = await fetch(`https://localhost:7287/api/notification-settings/telegram/chat-ids/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to delete');
                }

                logOutput('✅ Chat ID deleted successfully', 'success');
                getNotificationSettings();
            } catch (err) {
                logOutput(`❌ Delete chat ID error: ${err.message}`, 'error');
            }
        }

        // ===== 🆕 ALERT RULES FUNCTIONS =====

        async function createAlertRule() {
            const serverId = parseInt(document.getElementById('alertRuleServerId').value);
            const metric = document.getElementById('alertRuleMetric').value;
            const targetType = parseInt(document.getElementById('alertRuleTargetType').value);
            const targetId = document.getElementById('alertRuleTargetId').value || null;
            const comparison = document.getElementById('alertRuleComparison').value;
            const threshold = parseFloat(document.getElementById('alertRuleThreshold').value);
            const severity = document.getElementById('alertRuleSeverity').value;
            const cooldown = parseInt(document.getElementById('alertRuleCooldown').value);

            logOutput(`⏳ Creating alert rule...`, 'info');

            try {
                const response = await fetch(`https://localhost:7287/api/servers/${serverId}/alert-rules`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        monitoredServerId: serverId,
                        metric,
                        targetType,
                        targetId,
                        thresholdValue: threshold,
                        comparison,
                        severity,
                        cooldownMinutes: cooldown
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to create rule');
                }

                const result = await response.json();
                logOutput(`✅ Alert rule created: ${metric} ${comparison} ${threshold} (ID: ${result.id})`, 'success');
                loadAlertRules();
            } catch (err) {
                logOutput(`❌ Create alert rule error: ${err.message}`, 'error');
            }
        }

        async function loadAlertRules() {
            const serverId = parseInt(document.getElementById('alertRuleServerId').value);
            
            try {
                const response = await fetch(`https://localhost:7287/api/servers/${serverId}/alert-rules`, {
                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                });

                if (!response.ok) throw new Error('Failed to load rules');

                const rules = await response.json();
                displayAlertRules(rules);
            } catch (err) {
                document.getElementById('alertRulesList').innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
            }
        }

        function displayAlertRules(rules) {
            const container = document.getElementById('alertRulesList');
            
            if (!rules || rules.length === 0) {
                container.innerHTML = '<p style="color:#999;">No alert rules found. Create one above.</p>';
                return;
            }

            let html = '';
            rules.forEach(rule => {
                const targetTypes = ['Server', 'Disk', 'Network', 'Process', 'Service'];
                const statusBadge = rule.isActive 
                    ? '<span class="badge badge-success">Active</span>' 
                    : '<span class="badge badge-danger">Inactive</span>';
                
                html += `
                    <div class="alert-rule-item">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <strong>${rule.metric}</strong> ${rule.comparison} ${rule.thresholdValue}
                                ${statusBadge}
                                <span class="badge badge-${rule.severity.toLowerCase()}">${rule.severity}</span>
                            </div>
                            <button class="danger" style="padding:5px 10px;" onclick="deleteAlertRule(${rule.monitoredServerId}, ${rule.id})">Delete</button>
                        </div>
                        <small>
                            Target: ${targetTypes[rule.targetType]}${rule.targetId ? ` (${rule.targetId})` : ''} | 
                            Cooldown: ${rule.cooldownMinutes}min | 
                            Created: ${new Date(rule.createdAtUtc).toLocaleString()}
                        </small>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        async function deleteAlertRule(serverId, ruleId) {
            if (!confirm('Delete this alert rule?')) return;

            try {
                const response = await fetch(`https://localhost:7287/api/servers/${serverId}/alert-rules/${ruleId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                });

                if (!response.ok) throw new Error('Failed to delete rule');

                logOutput('✅ Alert rule deleted', 'success');
                loadAlertRules();
            } catch (err) {
                logOutput(`❌ Delete rule error: ${err.message}`, 'error');
            }
        }

        // ===== 🆕 ALERTS FUNCTIONS =====

        async function loadAlerts() {
            const serverId = document.getElementById('filterAlertServerId').value;
            const severity = document.getElementById('filterAlertSeverity').value;
            const acknowledged = document.getElementById('filterAlertAcknowledged').value;

            let url = 'https://localhost:7287/api/alerts?page=1&pageSize=50';
            if (serverId) url += `&serverId=${serverId}`;
            if (severity) url += `&severity=${severity}`;
            if (acknowledged) url += `&acknowledged=${acknowledged}`;

            try {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                });

                if (!response.ok) throw new Error('Failed to load alerts');

                const alerts = await response.json();
                displayAlerts(alerts);
            } catch (err) {
                document.getElementById('alertsList').innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
            }
        }

        function displayAlerts(alerts) {
            const container = document.getElementById('alertsList');
            
            if (!alerts || alerts.length === 0) {
                container.innerHTML = '<p style="color:#999;">No alerts found.</p>';
                return;
            }

            let html = '';
            alerts.forEach(alert => {
                const emoji = alert.severity === 'Critical' ? '🔴' : alert.severity === 'Warning' ? '⚠️' : 'ℹ️';
                const ackBadge = alert.isAcknowledged 
                    ? '<span class="badge badge-success">Acknowledged</span>' 
                    : '<span class="badge badge-warning">Unacknowledged</span>';
                
                html += `
                    <div class="alert-item">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                ${emoji} <strong>${alert.title}</strong>
                                ${ackBadge}
                                <span class="badge badge-${alert.severity.toLowerCase()}">${alert.severity}</span>
                            </div>
                            <div>
                                ${!alert.isAcknowledged ? `<button class="success" style="padding:5px 10px;" onclick="acknowledgeAlert(${alert.id})">Acknowledge</button>` : ''}
                                <button class="danger" style="padding:5px 10px;" onclick="deleteAlert(${alert.id})">Delete</button>
                            </div>
                        </div>
                        <p style="margin:8px 0;">${alert.message}</p>
                        <small>
                            Server: ${alert.serverName} (ID: ${alert.monitoredServerId}) | 
                            Time: ${new Date(alert.createdAtUtc).toLocaleString()}
                            ${alert.acknowledgedAtUtc ? ` | Ack: ${new Date(alert.acknowledgedAtUtc).toLocaleString()}` : ''}
                        </small>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        async function acknowledgeAlert(alertId) {
            try {
                const response = await fetch(`https://localhost:7287/api/alerts/${alertId}/acknowledge`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                });

                if (!response.ok) throw new Error('Failed to acknowledge');

                logOutput(`✅ Alert ${alertId} acknowledged`, 'success');
                loadAlerts();
            } catch (err) {
                logOutput(`❌ Acknowledge error: ${err.message}`, 'error');
            }
        }

        async function deleteAlert(alertId) {
            if (!confirm('Delete this alert?')) return;

            try {
                const response = await fetch(`https://localhost:7287/api/alerts/${alertId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                });

                if (!response.ok) throw new Error('Failed to delete');

                logOutput('✅ Alert deleted', 'success');
                loadAlerts();
            } catch (err) {
                logOutput(`❌ Delete alert error: ${err.message}`, 'error');
            }
        }

        async function deleteAcknowledgedAlerts() {
            if (!confirm('Delete all acknowledged alerts?')) return;

            const serverId = document.getElementById('filterAlertServerId').value;
            let url = 'https://localhost:7287/api/alerts/acknowledged';
            if (serverId) url += `?serverId=${serverId}`;

            try {
                const response = await fetch(url, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                });

                if (!response.ok) throw new Error('Failed to delete');

                const result = await response.json();
                logOutput(`✅ Deleted ${result.count} acknowledged alerts`, 'success');
                loadAlerts();
            } catch (err) {
                logOutput(`❌ Delete acknowledged error: ${err.message}`, 'error');
            }
        }

        // ===== 🆕 AGENT INSTALLATION FUNCTIONS =====

        async function registerAgent() {
            const name = document.getElementById('newAgentName').value;
            if (!name) {
                alert('Please enter agent name');
                return;
            }

            logOutput(`⏳ Registering new agent: <strong>${name}</strong>...`, 'info');

            try {
                const response = await fetch('https://localhost:7287/api/agents/register', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Registration failed');
                }

                const data = await response.json();
                
                const html = `
                    <strong>✅ Agent Registered Successfully!</strong><br/>
                    • ID: <code>${data.id}</code><br/>
                    • Name: <strong>${data.name}</strong><br/>
                    • Token: <code>${data.token.substring(0, 20)}...</code><br/>
                    <br/>
                    <strong>🚀 Installation Command:</strong><br/>
                    <div class="install-command">${data.installCommand}</div>
                    <br/>
                    Copy this command and run it on your Linux server (Ubuntu/Debian).
                `;
                
                logOutput(html, 'success');
                document.getElementById('newAgentName').value = '';
                loadAgents();
            } catch (err) {
                logOutput(`❌ Register agent error: ${err.message}`, 'error');
            }
        }

        async function loadAgents() {
            logOutput('⏳ Loading agents...', 'info');

            try {
                const response = await fetch('https://localhost:7287/api/agents', {
                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                });

                if (!response.ok) throw new Error('Failed to load agents');

                const agents = await response.json();
                displayAgents(agents);
                logOutput(`✅ Loaded ${agents.length} agents`, 'success');
            } catch (err) {
                logOutput(`❌ Load agents error: ${err.message}`, 'error');
            }
        }

        function displayAgents(agents) {
            const container = document.getElementById('agentsList');
            
            if (!agents || agents.length === 0) {
                container.innerHTML = '<p style="color:#999;">No agents registered. Register one above.</p>';
                return;
            }

            let html = '';
            agents.forEach(agent => {
                const statusIcon = agent.isOnline ? '🟢' : '🔴';
                const statusText = agent.isOnline ? 'Online' : 'Offline';
                
                html += `
                    <div class="agent-item">
                        <div>
                            ${statusIcon} <strong>${agent.name}</strong>
                            <br/>
                            <small>ID: ${agent.id} | ${agent.hostname || 'Not connected yet'}</small>
                            ${agent.lastSeenUtc ? `<br/><small>Last seen: ${new Date(agent.lastSeenUtc).toLocaleString()}</small>` : ''}
                        </div>
                        <div>
                            <button onclick="getInstallScript(${agent.id})" style="padding:5px 10px;">Get Install Script</button>
                            <button onclick="getAgentStatus(${agent.id})" style="padding:5px 10px;">Status</button>
                            <button class="danger" onclick="deleteAgent(${agent.id}, '${agent.name}')" style="padding:5px 10px;">Delete</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        async function getInstallScript(agentId) {
            logOutput(`⏳ Getting installation script for agent ${agentId}...`, 'info');

            try {
                const response = await fetch(`https://localhost:7287/api/agents/install/${agentId}`, {
                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                });

                if (!response.ok) throw new Error('Failed to get install script');

                const script = await response.text();
                
                const curlCommand = `curl -sL https://localhost:7287/api/agents/install/${agentId} | sudo bash`;
                
                const html = `
                    <strong>📋 Installation Script for Agent ${agentId}</strong><br/>
                    <br/>
                    <strong>Quick Install (One Command):</strong><br/>
                    <div class="install-command">${curlCommand}</div>
                    <br/>
                    <strong>Full Script:</strong><br/>
                    <textarea readonly style="width:100%;height:300px;font-family:monospace;font-size:12px;">${script}</textarea>
                `;
                
                logOutput(html, 'success');
            } catch (err) {
                logOutput(`❌ Get install script error: ${err.message}`, 'error');
            }
        }

        async function getAgentStatus(agentId) {
            logOutput(`⏳ Getting status for agent ${agentId}...`, 'info');

            try {
                const response = await fetch(`https://localhost:7287/api/agents/${agentId}/status`, {
                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                });

                if (!response.ok) throw new Error('Failed to get status');

                const data = await response.json();
                
                const statusIcon = data.isOnline ? '🟢' : '🔴';
                const statusText = data.isOnline ? 'Online' : 'Offline';
                
                const html = `
                    <strong>${statusIcon} Agent Status: ${data.name}</strong><br/>
                    • ID: <code>${data.id}</code><br/>
                    • Status: <strong>${statusText}</strong><br/>
                    • Last Seen: ${data.lastSeenUtc ? new Date(data.lastSeenUtc).toLocaleString() : 'Never'}
                `;
                
                logOutput(html, data.isOnline ? 'success' : 'info');
            } catch (err) {
                logOutput(`❌ Get agent status error: ${err.message}`, 'error');
            }
        }

        async function deleteAgent(agentId, name) {
            if (!confirm(`Delete agent "${name}"? This cannot be undone.`)) return;

            logOutput(`⏳ Deleting agent ${agentId}...`, 'info');

            try {
                const response = await fetch(`https://localhost:7287/api/agents/${agentId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${jwtToken}` }
                });

                if (!response.ok) throw new Error('Failed to delete agent');

                logOutput(`✅ Agent "${name}" deleted successfully`, 'success');
                loadAgents();
            } catch (err) {
                logOutput(`❌ Delete agent error: ${err.message}`, 'error');
            }
        }

        // Auto-load agents after login
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('https://localhost:7287/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                if (!response.ok) {
                    throw new Error('Invalid credentials');
                }

                const data = await response.json();
                jwtToken = data.token;
                
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('userInfo').style.display = 'block';
                document.getElementById('userEmail').textContent = data.user.email;
                document.getElementById('authStatus').className = 'status authenticated';
                document.getElementById('authStatus').textContent = '✅ Authenticated';
                document.getElementById('connectBtn').disabled = false;

                logOutput(`✅ Logged in as <strong>${data.user.email}</strong>`, 'success');
                
                // Auto-load agents
                loadAgents();
            } catch (err) {
                logOutput(`❌ Login failed: ${err.message}`, 'error');
            }
        }

        // ...(existing code for other functions)...
    </script>
</body>
</html>
